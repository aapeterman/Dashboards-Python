import plaid
from plaid.api import plaid_api
from plaid.model.transactions_sync_request import TransactionsSyncRequest
from plaid.model.accounts_balance_get_request import AccountsBalanceGetRequest
from plaid.configuration import Configuration
from plaid.api_client import ApiClient
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pandas as pd
import os
from datetime import datetime, date
from dotenv import load_dotenv
import numpy as np
import json

def flatten_tx(tx, bank_name):
    """Clean, flat transaction row - only desired fields"""
    if hasattr(tx, 'to_dict'):
        d = tx.to_dict()
    else:
        d = tx

    flat = {}
    flat['transaction_id'] = d.get('transaction_id')
    flat['date'] = d.get('date') if isinstance(d.get('date'), str) else d.get('date').isoformat() if d.get('date') else None
    flat['authorized_date'] = d.get('authorized_date') if isinstance(d.get('authorized_date'), str) else d.get('authorized_date').isoformat() if d.get('authorized_date') else None
    flat['amount'] = d.get('amount')
    flat['name'] = d.get('name')
    flat['merchant_name'] = d.get('merchant_name')
    flat['category'] = ', '.join(d.get('category', [])) if d.get('category') else None
    flat['category_id'] = d.get('category_id')
    flat['payment_channel'] = d.get('payment_channel')
    flat['pending'] = d.get('pending')
    flat['currency'] = d.get('iso_currency_code')
    flat['bank_name'] = bank_name
    flat['account_name'] = d.get('account_name') or d.get('account_official_name') or 'Unknown Account'

    loc = d.get('location', {})
    flat['city'] = loc.get('city')
    flat['region'] = loc.get('region')
    flat['postal_code'] = loc.get('postal_code')

    pfc = d.get('personal_finance_category', {})
    flat['pf_category'] = pfc.get('primary')
    flat['pf_confidence'] = pfc.get('confidence')

    return flat

load_dotenv('- wade.env')

print("ENV CHECK")
print("Tokens:", sum(1 for k in os.environ if k.startswith('PLAID_ACCESS_TOKEN')))
print("─" * 40 + "\n")

configuration = Configuration(
    host=getattr(plaid.Environment, os.getenv('PLAID_ENV', 'sandbox').capitalize()),
    api_key={'clientId': os.getenv('PLAID_CLIENT_ID'), 'secret': os.getenv('PLAID_SECRET')}
)
api_client = ApiClient(configuration)
client = plaid_api.PlaidApi(api_client)

scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
creds_path = os.getenv('GOOGLE_CREDENTIALS_PATH', 'wade-service-account.json')
creds = ServiceAccountCredentials.from_json_keyfile_name(creds_path, scope)
gc = gspread.authorize(creds)

spreadsheet = gc.open("Wade Finance Dashboard")
print("Opened: Wade Finance Dashboard\n")

banks = [
    ('PLAID_ACCESS_TOKEN',   'First Bank',      'First Bank Balance'),
    ('PLAID_ACCESS_TOKEN_2', 'Stockmens',       'Stockmens Balance'),
    ('PLAID_ACCESS_TOKEN_3', 'First Citizens',  'First Citizens Balance'),
    ('PLAID_ACCESS_TOKEN_4', 'ENT',             'ENT Balance'),
]

access_tokens = []
bank_names = {}
balance_tabs = {}

for key, bname, bal_tab in banks:
    token = os.getenv(key)
    if token:
        access_tokens.append(token)
        bank_names[token] = bname
        balance_tabs[token] = bal_tab

print(f"Found {len(access_tokens)} tokens\n")

all_tx_rows = []

for token in access_tokens:
    bank = bank_names[token]
    bal_tab = balance_tabs[token]

    print(f"Processing {bank}...")

    cursor_file = f'cursor_{token[:8]}.txt'
    cursor = None
    if os.path.exists(cursor_file):
        with open(cursor_file, 'r') as f:
            cursor = f.read().strip()

    req = TransactionsSyncRequest(access_token=token, cursor=cursor or "")

    resp = None
    for attempt in range(3):
        try:
            resp = client.transactions_sync(req)
            break
        except Exception as e:
            print(f"  Attempt {attempt+1} failed: {str(e)[:100]}...")
            if "cursor" in str(e).lower() or "mutation" in str(e).lower():
                req.cursor = ""
            else:
                break

    if resp is None:
        print(f"  Failed {bank}")
        continue

    raw = resp['added'] + resp['modified']
    print(f"  Fetched {len(raw)} tx")

    cleaned = [flatten_tx(tx, bank) for tx in raw]

    print(f"  Cleaned → {len(cleaned)}")

    all_tx_rows.extend(cleaned)

    if resp.get('next_cursor'):
        with open(cursor_file, 'w') as f:
            f.write(resp['next_cursor'])

    # Balance
    try:
        bal_resp = client.accounts_balance_get(AccountsBalanceGetRequest(access_token=token))
        accts = [a.to_dict() for a in bal_resp['accounts']]
        bal_rows = []
        for a in accts:
            b = a.get('balances', {})
            row = {
                'account_id': a.get('account_id'),
                'name': a.get('name'),
                'type': a.get('type'),
                'subtype': a.get('subtype'),
                'pending': b.get('pending'),
                'current': b.get('current'),
                'available': b.get('available'),
                'limit': b.get('limit'),
                'iso_currency_code': b.get('iso_currency_code'),
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'bank_name': bank
            }
            bal_rows.append({k: flatten_value(v) for k, v in row.items()})

        df_bal = pd.DataFrame(bal_rows).replace({np.nan: None})

        ws_bal = spreadsheet.worksheet(bal_tab) if bal_tab in [w.title for w in spreadsheet.worksheets()] else \
                 spreadsheet.add_worksheet(title=bal_tab, rows=200, cols=20)

        ws_bal.clear()
        ws_bal.append_rows([df_bal.columns.tolist()] + df_bal.values.tolist())
        print(f"  Balances: {len(df_bal)} rows → '{bal_tab}'")
    except Exception as e:
        print(f"  Balance error: {str(e)[:100]}...")

# Combined transactions - STRICT COLUMNS, HEADERS FIXED
if all_tx_rows:
    print(f"\nCombining {len(all_tx_rows)} transactions...")

    df_all = pd.DataFrame(all_tx_rows).replace({np.nan: None})

    # Strict column order - no extras allowed to shift data
    strict_cols = [
        'transaction_id', 'date', 'authorized_date', 'amount', 'name', 'merchant_name',
        'category', 'category_id', 'payment_channel', 'pending', 'currency',
        'bank_name', 'account_name', 'city', 'region', 'postal_code', 'address',
        'pf_category', 'pf_confidence'
    ]

    # Reindex to force exactly these columns (drops any extras, fills missing with None)
    df_all = df_all.reindex(columns=strict_cols)

    try:
        ws_comb = spreadsheet.worksheet('All Transactions Combined')
    except gspread.exceptions.WorksheetNotFound:
        ws_comb = spreadsheet.add_worksheet(title='All Transactions Combined', rows=10000, cols=100)
        print("Created 'All Transactions Combined'")

    existing_headers = ws_comb.row_values(1)
    expected_headers = strict_cols

    if not existing_headers or existing_headers != expected_headers:
        print("Headers missing or mismatched → resetting tab with clean headers")
        ws_comb.clear()
        ws_comb.update('A1', [expected_headers])

    ws_comb.append_rows(df_all.values.tolist())
    print(f"→ Added {len(df_all)} rows to 'All Transactions Combined' (strict columns, aligned)")

else:
    print("No transactions this run.")

# Airbnb CSVs
print("\nAirbnb CSVs:")
BASE_DIR = r"C:\Users\aaron\quickstart\python"

airbnb_configs = [
    ("AirBnB Pending", ["airbnb_pending.csv"]),
    ("AirBnB Paid",    ["airbnb_.csv"])
]

for tab_name, files in airbnb_configs:
    for fname in files:
        path = os.path.join(BASE_DIR, fname)
        if os.path.exists(path):
            try:
                df = pd.read_csv(path, encoding='utf-8', on_bad_lines='skip', low_memory=False)
                df = df.replace({np.nan: None}).fillna('')

                print(f"Loaded '{fname}' → {len(df)} rows")

                ws = spreadsheet.worksheet(tab_name) if tab_name in [w.title for w in spreadsheet.worksheets()] else \
                     spreadsheet.add_worksheet(title=tab_name, rows=5000, cols=100)

                ws.clear()
                ws.append_rows([df.columns.tolist()] + df.values.tolist())
                print(f"  ✓ Uploaded {len(df)} rows to '{tab_name}'")
            except Exception as e:
                print(f"  '{fname}' error: {str(e)[:100]}...")
            break
    else:
        print(f"  No file for '{tab_name}'")

print("\nFinished. Refresh sheet – columns should now be perfectly aligned with headers at top.")
