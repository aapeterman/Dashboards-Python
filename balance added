import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pandas as pd
import os
from datetime import datetime
from dotenv import load_dotenv

load_dotenv('- wade.env')

scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
creds_path = os.getenv('GOOGLE_CREDENTIALS_PATH', 'wade-service-account.json')
creds = ServiceAccountCredentials.from_json_keyfile_name(creds_path, scope)
gc = gspread.authorize(creds)

spreadsheet = gc.open("Wade Finance Dashboard")
print("Opened: Wade Finance Dashboard\n")

# Per-bank transaction tabs (from your last run)
per_bank_tabs = [
    'First Bank Transactions',
    'Stockmens Transactions',
    'First Citizens Transactions',
    'ENT Transactions'
]

# Combined Transactions tab
combined_tx_tab = 'All Transactions Combined'

print("Stacking transactions from per-bank tabs...")

all_tx_rows = []

for tab_name in per_bank_tabs:
    try:
        ws = spreadsheet.worksheet(tab_name)
        rows = ws.get_all_values()
        if not rows:
            print(f"  {tab_name} is empty - skipping")
            continue

        headers = rows[0]
        bank_name = tab_name.replace(' Transactions', '')  # e.g. "First Bank"
        print(f"  Reading {tab_name} ({len(rows)-1} rows)")

        for row in rows[1:]:
            row_dict = dict(zip(headers, row))
            row_dict['bank_name'] = bank_name
            all_tx_rows.append(row_dict)
    except gspread.exceptions.WorksheetNotFound:
        print(f"  Tab not found: {tab_name} - skipping")
    except Exception as e:
        print(f"  Error reading {tab_name}: {str(e)[:100]}...")

if all_tx_rows:
    df_all = pd.DataFrame(all_tx_rows)

    # Clean column order
    desired_cols = df_all.columns.tolist()  # keep existing columns
    if 'bank_name' not in desired_cols:
        desired_cols.append('bank_name')

    df_all = df_all.reindex(columns=desired_cols)

    try:
        ws_comb = spreadsheet.worksheet(combined_tx_tab)
    except gspread.exceptions.WorksheetNotFound:
        ws_comb = spreadsheet.add_worksheet(title=combined_tx_tab, rows=10000, cols=100)

    ws_comb.clear()
    ws_comb.append_rows([df_all.columns.tolist()] + df_all.values.tolist())
    print(f"→ All Transactions Combined: {len(df_all)} rows (stacked from per-bank tabs)")
else:
    print("No transaction data found in per-bank tabs.")

# Combined Balances - stack from per-bank balance tabs
print("\nStacking balances...")

combined_bal_rows = []

balance_tabs = [
    'First Bank Balance',
    'Stockmens Balance',
    'First Citizens Balance',
    'ENT Balance'
]

for tab_name in balance_tabs:
    try:
        ws_bal = spreadsheet.worksheet(tab_name)
        rows = ws_bal.get_all_values()
        if not rows:
            print(f"  {tab_name} is empty - skipping")
            continue

        headers = rows[0]
        bank_name = tab_name.replace(' Balance', '')
        print(f"  Reading {tab_name} ({len(rows)-1} rows)")

        for row in rows[1:]:
            row_dict = dict(zip(headers, row))
            row_dict['bank_name'] = bank_name
            combined_bal_rows.append(row_dict)
    except gspread.exceptions.WorksheetNotFound:
        print(f"  Tab not found: {tab_name} - skipping")
    except Exception as e:
        print(f"  Error reading {tab_name}: {str(e)[:100]}...")

if combined_bal_rows:
    df_bal = pd.DataFrame(combined_bal_rows)

    ws_bal_comb = spreadsheet.worksheet('Combined Balances') if 'Combined Balances' in [w.title for w in spreadsheet.worksheets()] else \
                   spreadsheet.add_worksheet(title='Combined Balances', rows=200, cols=20)

    ws_bal_comb.clear()
    ws_bal_comb.append_rows([df_bal.columns.tolist()] + df_bal.values.tolist())
    print(f"→ Combined Balances: {len(df_bal)} rows (stacked from per-bank balance tabs)")
else:
    print("No balance data found in per-bank tabs.")

print("\nFinished. Refresh the sheet.")
print("Check:")
print("• Per-bank transaction tabs")
print("• All Transactions Combined (stacked with bank_name)")
print("• Combined Balances (stacked total balance)")
