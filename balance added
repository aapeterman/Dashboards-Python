import plaid
from plaid.api import plaid_api
from plaid.model.transactions_sync_request import TransactionsSyncRequest
from plaid.model.accounts_balance_get_request import AccountsBalanceGetRequest
from plaid.configuration import Configuration
from plaid.api_client import ApiClient
import json
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pandas as pd
import os
from datetime import datetime
from dotenv import load_dotenv
import numpy as np

def clean_nan(df):
    df = df.replace([np.nan, np.inf, -np.inf], '')
    df = df.astype(str).replace('nan', '').replace('None', '').replace('inf', '').replace('-inf', '')
    return df

load_dotenv()

CLIENT_ID = os.getenv('PLAID_CLIENT_ID')
SECRET = os.getenv('PLAID_SECRET')
ENV = os.getenv('PLAID_ENV', 'sandbox')

configuration = Configuration(
    host=getattr(plaid.Environment, ENV.capitalize()),
    api_key={'clientId': CLIENT_ID, 'secret': SECRET}
)
api_client = ApiClient(configuration)
client = plaid_api.PlaidApi(api_client)

scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
creds = ServiceAccountCredentials.from_json_keyfile_name('credentials.json', scope)
gc = gspread.authorize(creds)
spreadsheet = gc.open('Plaid_Transactions')

# Combined tab for transactions
TRANSACTIONS_TAB = 'All Transactions'
try:
    transactions_worksheet = spreadsheet.worksheet(TRANSACTIONS_TAB)
    print(f"Using existing transactions tab: {TRANSACTIONS_TAB}")
except gspread.exceptions.WorksheetNotFound:
    transactions_worksheet = spreadsheet.add_worksheet(title=TRANSACTIONS_TAB, rows=2000, cols=50)
    print(f"Created transactions tab: {TRANSACTIONS_TAB}")

# Separate balance tabs per bank
BALANCE_TABS = {
    os.getenv('PLAID_ACCESS_TOKEN'): 'ENT Business Balance',
    os.getenv('PLAID_ACCESS_TOKEN_2'): 'ENT Personal Balance',
}

# Load tokens from .env
ACCESS_TOKENS = []
token_keys = ['PLAID_ACCESS_TOKEN', 'PLAID_ACCESS_TOKEN_2']
for key in token_keys:
    token = os.getenv(key)
    if token:
        ACCESS_TOKENS.append(token)
        print(f"Loaded token from {key}: {token[:20]}...")

if not ACCESS_TOKENS:
    print("No access tokens found in .env")
    exit()

print(f"Found {len(ACCESS_TOKENS)} tokens to sync")

all_transactions = []

for token in ACCESS_TOKENS:
    bank_name = BANK_NAMES.get(token, 'Unknown Bank') if 'BANK_NAMES' in globals() else 'Unknown Bank'
    balance_tab_name = BALANCE_TABS.get(token, 'Unknown Balance')

    print(f"Syncing transactions for '{bank_name}' with token {token[:20]}...")

    cursor_file = f'plaid_cursor_{token[:8]}.txt'
    cursor = None
    if os.path.exists(cursor_file):
        with open(cursor_file, 'r') as f:
            cursor = f.read().strip()

    sync_cursor = cursor if cursor is not None else ""

    request = TransactionsSyncRequest(access_token=token, cursor=sync_cursor)

    try:
        response = client.transactions_sync(request)
        transactions = response['added'] + response['modified']

        all_transactions.extend(transactions)

        if response['next_cursor']:
            with open(cursor_file, 'w') as f:
                f.write(response['next_cursor'])

        print(f"Added/updated {len(transactions)} transactions to '{TRANSACTIONS_TAB}'")

        # Fetch balances for this token
        try:
            balance_request = AccountsBalanceGetRequest(access_token=token)
            balance_response = client.accounts_balance_get(balance_request)
            # Convert Plaid objects to plain dicts to avoid serialization errors
            accounts = [acc.to_dict() for acc in balance_response['accounts']]
            print(f"Balances for {balance_tab_name}: {len(accounts)} accounts")

            # Get or create balance tab
            try:
                balance_worksheet = spreadsheet.worksheet(balance_tab_name)
                print(f"Using existing balance tab: {balance_tab_name}")
            except gspread.exceptions.WorksheetNotFound:
                balance_worksheet = spreadsheet.add_worksheet(title=balance_tab_name, rows=2000, cols=50)
                print(f"Created new balance tab: {balance_tab_name}")

            # Append balance rows
            balance_rows = []
            for acc in accounts:
                bal = acc['balances']
                balance_rows.append([
                    acc['account_id'],
                    acc['name'],
                    acc['type'],
                    acc['subtype'],
                    bal.get('available'),
                    bal.get('current'),
                    bal.get('limit'),
                    bal.get('iso_currency_code'),
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    bank_name
                ])

            if balance_rows:
                balance_worksheet.append_rows(balance_rows, value_input_option='RAW')
                print(f"Appended {len(balance_rows)} balance rows to '{balance_tab_name}'")

        except Exception as e:
            print(f"Error fetching balances for {balance_tab_name}: {e}")

    except Exception as e:
        print(f"Error with token {token[:20]}...: {e}")

print("Sync complete for all banks.")
